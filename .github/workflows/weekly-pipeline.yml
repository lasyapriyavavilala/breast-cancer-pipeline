name: Weekly Breast Cancer Pipeline

on:
  schedule:
    # Run every Sunday at 8 AM UTC (3 AM EST)
    - cron: '0 8 * * 0'
  workflow_dispatch:  # Allow manual triggering

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run pipeline
        env:
          # Twitter credentials
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
          
          # Groq API for LLM
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          
        run: |
          python run_pipeline.py \
            --target 5 \
            --days-back 7 \
            --polls-per-article 2 \
            --grounding-threshold 0.60 \
            --post-polls \
            --post-limit 10 \
            ----post-interval 1 \
            --no-dry-run
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: pipeline-outputs
          path: |
            data/raw/*.json
            data/processed/*.json
            data/outputs/*.json
          retention-days: 30